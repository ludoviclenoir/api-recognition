<!DOCTYPE html>
<html>
<head>
    <title>Object Detection and Classification</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <link rel="stylesheet" type="text/css" href="/styles.css">
</head>
<body>
    <h1>Object Detection and Classification</h1>
    <video id="video" width="640" height="480" autoplay></video>
    <canvas id="canvas" width="640" height="480"></canvas>
    <button id="capture">Capturer Image</button>
    <div id="prediction"></div> <!-- Element pour afficher la prédiction -->
    <div>
        <ul id="logs" class="logs">
            <!-- Les logs seront affichés ici -->
        </ul>
    </div>    
    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const predictionElement = document.getElementById('prediction');
        let model;
        let tfModel;

        tf.loadLayersModel('https://api-recognition.test/book/modele/model.json').then(loadedModel => {
            tfModel = loadedModel;
            log("TensorFlow Model Loaded.");
            startVideo();
        });

        let modelClasses;
        fetch('https://api-recognition.test/book/modele/classes.json')
            .then(response => response.json())
            .then(data => {
                modelClasses = data;
                log("Classes Model Loaded.");
            })
            .catch(error => {
                log('Erreur lors du chargement des classes:', error);
            });

        function preprocessImage(imageData) {
            const tfImg = tf.browser.fromPixels(imageData);
            const smallImg = tf.image.resizeBilinear(tfImg, [224, 153]);
            const normalized = smallImg.div(255.0).expandDims();
            return normalized;
        }

        async function predictImage(imageData) {
            const preprocessed = preprocessImage(imageData);
            const prediction = await tfModel.predict(preprocessed);
            return prediction;
        }

        cocoSsd.load().then(loadedModel => {
            model = loadedModel;
            log("COCO-SSD Model Loaded.");
        });

        function startVideo() {
            const constraints = {
                video: { width: { ideal: 640 }, height: { ideal: 480 } }
            };

            navigator.mediaDevices.getUserMedia(constraints)
                .then(stream => {
                    video.srcObject = stream;
                    video.addEventListener('loadeddata', () => {
                        log("Video started");
                    });
                })
                .catch(console.error);
        }

        document.getElementById('capture').addEventListener('click', () => {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            predictImage(imageData).then(tfPrediction => {
                displayPrediction(tfPrediction, 0, 0, canvas.width);
            });
        });

        function displayPrediction(tfPrediction, x, y, width) {
            const probabilities = tf.softmax(tfPrediction);
            const predictedIndex = probabilities.argMax(1).dataSync()[0];
            const predictedProbability = probabilities.max().dataSync()[0];
            probabilities.dispose();
            log("< 0.5")
            // log("Predicted Class: " + predictedClass + " with probability: " + (predictedProbability * 100).toFixed(2) + "%");

            // if (predictedProbability >= 0.5 && modelClasses) {
                const predictedClass = modelClasses[predictedIndex];
                const text = `${predictedClass} (${(predictedProbability * 100).toFixed(2)}%)`;

                ctx.fillStyle = 'yellow';
                ctx.font = '16px Arial';
                ctx.fillText(text, x, y - 10);

                log("Predicted Class: " + predictedClass + " with probability: " + (predictedProbability * 100).toFixed(2) + "%");
            // }
            // else{

            // }
        }

        function log(msg) {
            const message = document.createTextNode(msg);
            const li = document.createElement("li");
            li.appendChild(message);
            logs.appendChild(li);

            while (logs.childNodes.length > 10) {
                logs.removeChild(logs.firstChild);
            }

            logs.scrollTop = logs.scrollHeight;
        }
    </script>
</body>
</html>
